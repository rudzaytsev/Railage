<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:security="http://www.springframework.org/schema/security"

       xsi:schemaLocation="http://www.springframework.org/schema/beans

       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/security
       http://www.springframework.org/schema/security/spring-security.xsd">


    <bean id="adminDataSource"
          class="org.springframework.jdbc.datasource.DriverManagerDataSource">

        <property name="driverClassName" value="com.mysql.jdbc.Driver" />
        <property name="url" value="jdbc:mysql://localhost:3306/railage" />
        <property name="username" value="root" />
        <property name="password" value="root" />
    </bean>



    <!-- enable use-expressions -->
    <security:http auto-config="false" use-expressions="true" entry-point-ref="loginUrlAuthenticationEntryPoint">

        <security:intercept-url pattern="/registration" access="isAnonymous()"/>
        <security:intercept-url pattern="/register/user" access="isAnonymous()"/>
        <security:intercept-url pattern="/build/route" access="hasRole('ROLE_EMPLOYEE')"/>
        <security:intercept-url pattern="/passengers/ride/**" access="hasRole('ROLE_EMPLOYEE')"/>
        <security:intercept-url pattern="/passengers/on/train/**" access="hasRole('ROLE_EMPLOYEE')"/>

        <security:intercept-url pattern="/login/**" access="hasAnyRole('ROLE_EMPLOYEE','ROLE_CLIENT')"/>
        <security:intercept-url pattern="/routes/**" access="hasAnyRole('ROLE_EMPLOYEE','ROLE_CLIENT')"/>
        <security:intercept-url pattern="/trains/**" access="hasAnyRole('ROLE_EMPLOYEE','ROLE_CLIENT')"/>
        <security:intercept-url pattern="/rides/**" access="hasAnyRole('ROLE_EMPLOYEE','ROLE_CLIENT')"/>
        <security:intercept-url pattern="/stations/**" access="hasAnyRole('ROLE_EMPLOYEE','ROLE_CLIENT')"/>
        <security:intercept-url pattern="/passengers/**" access="hasAnyRole('ROLE_EMPLOYEE','ROLE_CLIENT')"/>
        <security:intercept-url pattern="/add/**" access="hasRole('ROLE_EMPLOYEE')"/>

        <security:csrf disabled="true"/>
        <security:intercept-url pattern="/ajax/**" access="hasAnyRole('ROLE_EMPLOYEE','ROLE_CLIENT')"/>
        <!-- access denied page -->
        <security:access-denied-handler error-page="/error403" />

        <security:logout invalidate-session="true" logout-url="/j_spring_security_logout"
                         logout-success-url="/"/>

        <security:custom-filter position="FORM_LOGIN_FILTER" ref="customAuthFilter"  />
    </security:http>


    <bean id="loginUrlAuthenticationEntryPoint" class="org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint">
        <constructor-arg name="loginFormUrl" value="/" />
    </bean>

    <bean id="customAuthFilter"  class="com.tsystems.jschool.railage.security.UserAuthFilter">
        <property name="authenticationManager" ref="authManager" />
        <property name="authenticationFailureHandler" ref="failureHandler" />
        <property name="authenticationSuccessHandler" ref="successHandler" />
        <property name="filterProcessesUrl" value="/check" />
        <property name="postOnly" value="true" />
        <property name="requiresAuthenticationRequestMatcher" ref="authRequestMatcher" />
    </bean>

    <bean id="authRequestMatcher" class="org.springframework.security.web.util.matcher.AntPathRequestMatcher">
        <constructor-arg name="pattern" value="/"  />
        <constructor-arg name="httpMethod" value="POST"/>
    </bean>

    <bean id="successHandler" class="org.springframework.security.web.authentication.SavedRequestAwareAuthenticationSuccessHandler">
        <property name="defaultTargetUrl" value="/login" />
    </bean>

    <bean id="failureHandler" class="org.springframework.security.web.authentication.SimpleUrlAuthenticationFailureHandler">
        <property name="defaultFailureUrl" value="/auth/error" />
    </bean>


    <bean id="passwordEncoder" class="org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder">
        <constructor-arg value="10" />
    </bean>


    <bean id="customUserDetailsService" class="com.tsystems.jschool.railage.security.UserDetailsServiceImpl" />
    <!-- Select users and user_roles from database -->
    <security:authentication-manager id="authManager">
        <security:authentication-provider user-service-ref="customUserDetailsService">
            <security:password-encoder ref="passwordEncoder"/>
        </security:authentication-provider>
    </security:authentication-manager>

</beans>